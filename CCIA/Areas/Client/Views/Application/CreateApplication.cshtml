@model CCIA.Models.ApplicationViewModel

@{
    ViewData["Title"] = @Model.AppType.AppTypeTrans +  "Application";
}

<section class="app-header">
    <h2>Application to @Model.AppType.CertificateTitle</h2>
    <h5>@Model.Application.ApplicantOrganization.Name</h5>
</section>
 
<div id="errors" class="text-danger">
    @Html.ValidationSummary()
</div>

<div class="card">
    <div class="card-body">
        <h5 class="card-title">Grower:</h5>
        <table class="table">
            <thead>
                <tr>
                    <th>Account #</th>
                    <th>Grower</th>
                    <th>Address</th>
                    <th>City</th>
                    <th>State</th>
                </tr>
            </thead>
            <tbody id="organizations">
                <tr>
                    <td>@Model.GrowerOrg.Id</td>
                    <td>@Model.GrowerOrg.Name</td>
                    @if (@Model.GrowerOrg.Address != null)
                    {
                        <td>@Model.GrowerOrg.Address.Address1</td>
                        <td>@Model.GrowerOrg.Address.City</td>
                        @if (@Model.GrowerOrg.Address.StateProvince != null)
                        {
                            <td>@Model.GrowerOrg.Address.StateProvince.Name</td>
                        }                
                    }
                </tr>
            </tbody>
        </table>
    </div>
</div>


<form>
    <div class="row border">
        <div class="form-group col-sm-3 required">            
                <label asp-for="Application.CropId" class="col-form-label">Crop</label>
                <select asp-for="Application.CropId" class="form-control" asp-items="@(new SelectList(Model.Crops, "CropId","Name"))"></select>
        </div>          
        <div class="form-group col-sm-3 required">           
            <label asp-for="Application.CertYear" class="col-form-label">Cert Year</label>
            @{                
                var selectList = new List<int>();
                @for (int i = 0; i <= 1; i++)
                {
                    selectList.Add(Model.CertYear + i);
                }                 
            }
            <select asp-for="Application.CertYear" class="form-control" asp-items="@(new SelectList(selectList))"></select>           
        </div>
        <div class="form-group required col-sm-6 border">                     
            <label asp-for="Application.EnteredVariety" class="col-form-label">@Model.AppType.VarietyTitle</label>
            <div>
                @if(Model.AppType.Abbreviation != "PO" && Model.AppType.Abbreviation != "RQ" && Model.AppType.Abbreviation != "TG")
                {
                    <div class="btn-group col-sm-12">
                        <input type="text" asp-for="Application.EnteredVariety" placeholder="@Model.AppType.VarietyTitle" class="col-sm-10 form-control">
                        <button class="btn btn-primary dropdown-toggle" id="varietySearch" data-toggle="dropdown" data-display="static" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-search"></i>
                        </button>     
                        <div class="dropdown-menu dropdown-menu-right dropdown-menu-lg-left" id="DropdownId">
                            <div class="text-center">
                                <div class="spinner-border text-center" role="status"><span class="sr-only">Loading...</span></div>
                            </div>
                        </div> 
                    </div>
                } else
                {
                    <select class="form-control col-sm-10" asp-for="Application.EnteredVariety" asp-items="@(new SelectList(Model.PrefiilledVarieties,"Id","Name"))" onchange="ddlVarietySelected()"></select>
                }
            </div>
    </div> 

    <div id="form-remainder" class="collapse col-sm-12">
        <hr>
        <div class="form-group required row">
            <label asp-for=Application.ClassProducedId class="col-form-label col-sm-3">Class to be Produced</label> 
            <div class="col-sm-9">         
            @foreach (var item in Model.ClassProducedList) 
            {
                <div class="form-check form-check-inline">
                    <input class="form-check-input lgRadio" type="radio" asp-for="Application.ClassProducedId" value="@item.ClassProducedId">
                    <label class="form-check-label" for="@item.ClassProducedId">@item.ClassProducedTrans</label>                    
                </div>
            } 
            </div> 
            <span class="field-validation-valid text-danger" data-valmsg-for="Application.ClassProducedId" data-valmsg-replace="true"></span>
            <hr>
        </div>
 
        <section id="planting-stock" class="rounded-section off-white">
            <h4>Planting Stock</h4>

            <!-- First Planting Stock form --> 
           <section class="rounded-section light-grey">
                <div class="row">
                    <div class="form-group required col-sm-5">
                        <label for="ps1_PsEnteredVariety" class="col-form-label">@Model.AppType.VarietyLabel</label>
                        <input type="text" id="ps1_PsEnteredVariety" class="form-control col-sm-5" placeholder="@Model.AppType.VarietyLabel"> 
                        <span class="field-validation-valid text-danger" data-valmsg-for="ps1_PsEnteredVariety" data-valmsg-replace="true"></span>
                    </div>
                    <div class="form-group required col-sm-7">
                        <label for="ps1_PsCertNum" class="col-form-label">@Model.AppType.PlantingStockCertNumberLabel</label>
                        <input type="text" id="ps1_PsCertNum" class="form-control" placeholder="@Model.AppType.PlantingStockCertNumberLabel"> 
                        <span class="field-validation-valid text-danger" data-valmsg-for="ps1_PsCertNum" data-valmsg-replace="true"></span>
                    </div>
                </div>
                <div class="row">                    
                    <div class="form-group required col-sm-6">
                        <label class="col-form-label" for="ps1_PsClass">Class Planted</label>
                        <select id="ps1_PsClass" class="form-control" asp-items="@(new SelectList(Model.ClassProducedList,"ClassProducedId","ClassProducedTrans"))"></select>                             
                        <span class="field-validation-valid text-danger" data-valmsg-for="ps1_PsClass" data-valmsg-replace="true"></span>
                    </div>                    
                    <!-- Potato app doesn't have pounds planted field -->
                    @if(Model.AppType.Abbreviation != "PO")
                    {
                        <div class="form-group required">
                            <label for="ps1_PoundsPlanted" class="col-form-label">Pounds Planted
                                <!-- Special PVG Label -->
                                @if(Model.AppType.Abbreviation == "PV") {
                                    <text>(1 for G0)</text>
                                }
                            </label>
                            <input type="text" id="ps1_PoundsPlanted" class="form-control" placeholder="Pounds Planted">
                            <span class="field-validation-valid text-danger" data-valmsg-for="ps1_PoundsPlanted" data-valmsg-replace="true"></span>
                        </div>
                    }
                </div>
                <div class="row">
                    <!-- PVG, Rice QA,  and Heritage Apps don't have Tag Issued field -->
                    @if(Model.AppType.ShowPSTagIssued)
                    {
                        <div class="form-group col">
                            <label for="ps1_StaeCountryTagIssued" class="col-form-label">State/Country Where PS Tag or Breeder Letter Was Issued</label>
                            <select id="ps1_StaeCountryTagIssued" class="form-control" asp-items="@(new SelectList(Model.StateProvince,"StateProvinceId","Name"))"></select>
                        </div>
                    }
                    <div class="form-group col">
                            <label for="ps1_StaeCountryGrown" class="col-form-label">State/Country Where PS Was Grown</label>
                            <select id="ps1_StaeCountryGrown" class="form-control" asp-items="@(new SelectList(Model.StateProvince,"StateProvinceId","Name"))"></select>
                    </div>                    
                </div>
                <div class="row">
                    <div class="form-group col">
                        <label for="ps1_SeedPurchasedFrom" class="col-form-label">Seed purchased/acquired from</label>
                        <input type="text" id="ps1_SeedPurchasedFrom" class="form-control" placeholder="Seed purchased/acquired from">
                        <span class="field-validation-valid text-danger" data-valmsg-for="ps1_SeedPurchasedFrom" data-valmsg-replace="true"></span>
                    </div>
                    <!-- Hemp -->
                    @if(Model.AppType.Abbreviation == "HP")
                    {
                        <div class="form-group col">
                            <label for="ps1_ThcPercent" class="col-form-label">THC Percent</label>
                            <input type="text" id="ps1_ThcPercent" class="form-control" placeholder="THC Percent">
                            <span class="field-validation-valid text-danger" data-valmsg-for="ps1_ThcPercent" data-valmsg-replace="true"></span>
                        </div>
                    }
                </div>  
                @if(Model.AppType.Abbreviation == "PO")
                {
                    <div class="row col">
                        <h4>Winter test results are required for recertification:</h4>                            
                    </div>
                    <div class="row">                        
                        <div class="form-group col required">
                            <label for="ps1_WinterTest" class="col-form-label">Winter test completed?</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input lgRadio" type="radio"  id="ps1_WinterTest" value="Yes" name="ps1_WinterTest" >
                                <label class="form-check-label" for="ps1_WinterTestYes">Yes</label>                    
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input lgRadio" type="radio"  id="ps1_WinterTest" value="No" name="ps1_WinterTest" >
                                <label class="form-check-label" for="ps1_WinterTestNo">No</label>                    
                            </div>
                        </div>
                        <div class="col">
                            (If yes, documentation required)
                        </div>
                    </div>
                    <div class="row col">
                        <h4>For prenuclear and nuclear class planted:</h4>                            
                    </div>
                    <div class="row">                        
                        <div class="form-group col required">
                            <label for="ps1_WinterTest" class="col-form-label">Was this lot PVX tested?</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input lgRadio" type="radio"  id="ps1_PVXTested" value="Yes" name="ps1_PVXTested" >
                                <label class="form-check-label" for=ps1_WinterTestYes">Yes</label>                    
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input lgRadio" type="radio"  id="ps1_PVXTested" value="No" name="ps1_PVXTested" >
                                <label class="form-check-label" for=ps1_WinterTestNo">No</label>                    
                            </div>
                        </div>
                         <div class="col">
                            (If yes, documentation required)
                        </div>
                    </div>
                }              
            </section>
            @if(Model.AppType.showSecondPlantingStock)
            {
            <!-- Second Planting Stock form -->
            <div id="second_ps_button">
                <p><em>Enter both parent lines for hybrid production.</em></p>
                <div id="add-second-ps" class="btn btn-warning collapse show">Add a second planting stocks record</div>
            </div>
            <div id="second-ps" class="collapse">
                <section class="rounded-section light-blue pos-rel">
                <button type="button" id="remove-ps2" onclick="removeSecondPSEntry();" class="btn circular top-right-btn" data-toggle="tooltip" data-placement="top" title="Remove this planting stock record">
                    <i id="remove-ps2" class="fas fa-times"></i>
                </button>    
                <div class="row" id="second-ps-first-row">
                    <div class="form-group required col-sm-5">
                        <label for="ps2_PsEnteredVariety" class="col-form-label">@Model.AppType.VarietyLabel</label>
                        <input type="text" id="ps2_PsEnteredVariety" class="form-control col-sm-5" placeholder="@Model.AppType.VarietyLabel"> 
                        <span class="field-validation-valid text-danger" data-valmsg-for="ps2_PsEnteredVariety" data-valmsg-replace="true"></span>
                    </div>
                    <div class="form-group required col-sm-7">
                        <label for="ps2_PsCertNum" class="col-form-label">@Model.AppType.PlantingStockCertNumberLabel</label>
                        <input type="text" id="ps2_PsCertNum" class="form-control" placeholder="@Model.AppType.PlantingStockCertNumberLabel"> 
                        <span class="field-validation-valid text-danger" data-valmsg-for="ps2_PsCertNum" data-valmsg-replace="true"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group required col-sm-6">
                        <label class="col-form-label" for="ps2_PsClass">Class Planted</label>
                        <select id="ps2_PsClass" class="form-control" asp-items="@(new SelectList(Model.ClassProducedList,"ClassProducedId","ClassProducedTrans"))"></select>                             
                        <span class="field-validation-valid text-danger" data-valmsg-for="ps2_PsClass" data-valmsg-replace="true"></span>
                    </div>                    
                    <!-- Potato app doesn't have pounds planted field -->
                    @if(Model.AppType.Abbreviation != "PO")
                    {
                        <div class="form-group required">
                            <label for="ps2_PoundsPlanted" class="col-form-label">Pounds Planted
                                <!-- Special PVG Label -->
                                @if(Model.AppType.Abbreviation == "PV") {
                                    <text>(1 for G0)</text>
                                }
                            </label>
                            <input type="text" id="ps2_PoundsPlanted" class="form-control" placeholder="Pounds Planted">
                            <span class="field-validation-valid text-danger" data-valmsg-for="ps2_PoundsPlanted" data-valmsg-replace="true"></span>
                        </div>
                    }
                </div>
                <div class="row">
                    <!-- PVG, Rice QA,  and Heritage Apps don't have Tag Issued field -->
                    @if(Model.AppType.ShowPSTagIssued)
                    {
                        <div class="form-group col">
                            <label for="ps2_StaeCountryTagIssued" class="col-form-label">State/Country Where PS Tag or Breeder Letter Was Issued</label>
                            <select id="ps2_StaeCountryTagIssued" class="form-control" asp-items="@(new SelectList(Model.StateProvince,"StateProvinceId","Name"))"></select>
                        </div>
                    }
                    <div class="form-group col">
                            <label for="ps2_StaeCountryGrown" class="col-form-label">State/Country Where PS Was Grown</label>
                            <select id="ps2_StaeCountryGrown" class="form-control" asp-items="@(new SelectList(Model.StateProvince,"StateProvinceId","Name"))"></select>
                    </div>                    
                </div>
                <div class="row">
                    <div class="form-group col">
                        <label for="ps2_SeedPurchasedFrom" class="col-form-label">Seed purchased/acquired from</label>
                        <input type="text" id="ps2_SeedPurchasedFrom" class="form-control" placeholder="Seed purchased/acquired from">
                        <span class="field-validation-valid text-danger" data-valmsg-for="ps2_SeedPurchasedFrom" data-valmsg-replace="true"></span>
                    </div>
                    <!-- Hemp -->
                    @if(Model.AppType.Abbreviation == "HP")
                    {
                        <div class="form-group col">
                            <label for="ps2_ThcPercent" class="col-form-label">THC Percent</label>
                            <input type="text" id="ps2_ThcPercent" class="form-control" placeholder="THC Percent">
                            <span class="field-validation-valid text-danger" data-valmsg-for="ps2_ThcPercent" data-valmsg-replace="true"></span>
                        </div>
                    }
                </div>  
                </section>                
            </div>
            }
            
            

        </section> 
            

        <section id="field-info" class="rounded-section off-white">
            <h4>Field Information</h4>
            <div class="rounded-section light-grey" >
            <div class="row">
                <div class="form-group col required">
                    <label asp-for="Application.FieldName" class="col-form-label"></label>
                    <input asp-for="Application.FieldName" class="form-control" placeholder="Field Name">
                    <span class="field-validation-valid text-danger" data-valmsg-for="Application.FieldName" data-valmsg-replace="true"></span>
                </div>
                <!-- Date Time Picker -->
                <div class="form-group col required">
                    <label asp-for="Application.DatePlanted" class="col-form-label">Date Planted
                        @if(Model.AppType.Abbreviation == "PG")
                        {
                            <text>(or collection date for G0)</text>
                        }
                    </label>
                    <div class="input-group mb-3">
                        <input type="text" asp-for="Application.DatePlanted" class="form-control datepicker" placeholder="MM/DD/YYYY">
                        <div class="input-group-append" id="calendar-btn" onclick="$('.datepicker').focus();">
                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                        </div>
                    </div>       
                    <span class="field-validation-valid text-danger" data-valmsg-for="Application.DatePlanted" data-valmsg-replace="true"></span>  
                </div>
            </div>
            <div class="row">
                <div class="form-group col">
                     <div class="form-group required col-sm-6">
                        <label class="col-form-label" asp-for="Application.FarmCounty">Farm County</label>
                        <select asp-for="Application.FarmCounty" class="form-control" asp-items="@(new SelectList(Model.Counties,"CountyId","Name"))"></select>                             
                        <span class="field-validation-valid text-danger" data-valmsg-for="Application.FarmCounty" data-valmsg-replace="true"></span>
                    </div>  
                </div>
                    @if(Model.AppType.Abbreviation == "HP")
                    {
                        <div class="form-group col required">
                            <label asp-for="Application.CountyPermit">County Permit Number</label>
                            <input asp-for="Application.CountyPermit" class="form-control" placeholder="County Permit Number">
                            <span class="field-validation-valid text-danger" data-valmsg-for="Application.CountyPermit" data-valmsg-replace="true"></span>
                        </div>            
                    }
                <div class="form-group col required">
                    <label asp-for="Application.AcresApplied" class="col-form-label ">Acres Applied
                        <!-- PVG -->
                        @if(Model.AppType.Abbreviation == "PV") 
                        {
                            <text>(enter 1 for G0)</text>
                        }
                    </label>
                    <input asp-for="Application.AcresApplied" class="form-control" placeholder="Acres Applied">
                    <span class="field-validation-valid text-danger" data-valmsg-for="Application.AcresApplied" data-valmsg-replace="true"></span>
                </div>
            </div>

            <!-- PVG Fields -->
            @if(Model.AppType.Abbreviation == "PV")
            {
                <div class="row">
                    <div class="form-group required col-sm-6">
                        <label class="col-form-label" asp-for="Application.Ecoregion">US EPA Level III Ecoregion</label>
                        <select asp-for="Application.Ecoregion" class="form-control" asp-items="@(new SelectList(Model.Ecoregions,"Id","Name"))"></select>                             
                        <span class="field-validation-valid text-danger" data-valmsg-for="Application.Ecoregion" data-valmsg-replace="true"></span>
                    </div>                     
                    <div class="col form-group">
                        <label asp-for="Application.FieldElevation">Field Elevation</label>
                        <input asp-for="Application.FieldElevation" class="form-control" placeholder="Field Elevation">
                        <span class="field-validation-valid text-danger" data-valmsg-for="Application.FieldElevation" data-valmsg-replace="true"></span>                        
                    </div>
                </div>
            }

            <div class="form-group">
                <label asp-for="Application.ApplicantComments">Additional Information/Comments</label>
                <textarea rows="5" class="form-control" asp-for="Application.ApplicantComments" placeholder="Additional Information/Comments"></textarea>
            </div>

            <h5><strong>History:</strong></h5>
            <p><em>Application numbers and full crop history may be required for previous years as specified in crop standards.</em></p>

                    @{
                int fhEntryId = 1;
                int nextFhEntryId = fhEntryId+1;
                ViewBag.name = "FieldHistories["+fhEntryId+"].Year";
                ViewBag.startYearOffset = 0;
                ViewBag.endYearOffset = 6;
            }
            <button id="@fhEntryId" class="btn circular top-right-btn" data-toggle="tooltip" data-placement="top" title="Remove this field history record">
                <i class="fas fa-times"></i>
            </button>
            <div class="row">
                    @{                        
                        var cropYearList = new List<SelectListItem>();
                        @for (int i = 0; i <= ViewBag.endYearOffset; i++)
                        {
                            int year = Model.CertYear - 1 - i;
                            var newItem = new SelectListItem() { Value= year.ToString(), Text=year.ToString()};     
                            cropYearList.Add(newItem);                            
                        }  
                    }
                <table class="table">
                    <thead>
                        <th>Crop Year</th>
                        <th>Crop</th>
                        <th>Variety or Crop not in list</th>
                        <th>Application Number</th>
                    </thead>
                    <tbody>
                        @for(int j =0; j <= Model.AppType.FieldHistoryCount; j++)
                        {                            
                            int year = Model.CertYear - 1 - j;  
                            <tr>
                                <td>
                                   <select id="FhYear_@(j)" class="form-control">
                                       @foreach (var item in cropYearList)
                                       {
                                           if(item.Value == year.ToString())
                                           {
                                               <option value="item.value" selected>@item.Value</option>
                                           } else
                                           {
                                               <option value="item.value">@item.Value</option>
                                           }
                                       }
                                   </select> 
                                </td>
                                <td>
                                     <select id="FHCrop_@(j)" class="form-control" asp-items="@(new SelectList(Model.FullCrops, "CropId","Name"))">
                                         <option value="0">Select crop...</option>
                                     </select>
                                </td>
                                <td>
                                    <input type="text" id="FHVariety_@(j)" class="form-control">
                                </td>
                                <td>
                                    <input type="text" id="FHAppNum_@(j)" class="form-control">
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                
            </div>
        </section>

        <div class="text-right">
            <button type="submit" class="btn btn-primary">Continue with Application</button>
        </div>     
    </div>

    <!-- Hidden fields -->
    <input type="hidden" id="Application.SelectedVarietyId" value="">   
    @Html.TextBox("AppSpecificPlantingStocks[0].OfficialVarietyId", "", new { type="hidden", id="ps1-variety-id" })
    <input type="hidden" readonly="readonly" class="form-control" id="app-type-id" name="AppType" value="SD">

    <!-- Alert dialog modals -->
    @{
        var cropAlert = new AlertViewModel("cropAlert", "Error: A crop must be selected.", "Please select a crop before searching for a variety.", "Close", "Ok");
        var varietyAlert = new AlertViewModel("varAlert", "Warning: No variety found", "No variety with the entered name was found in our system.Application. A new variety will be used.", "Close", "Ok");
        var emptyVarietyAlert = new AlertViewModel("emptyVarAlert", "Variety cannot be blank", "Please enter a variety name before searching for a variety.", "Close", "Ok");
    }
    @await Html.PartialAsync("~/Views/Shared/_AlertModal.cshtml", cropAlert)
    @await Html.PartialAsync("~/Views/Shared/_AlertModal.cshtml", varietyAlert)
    @await Html.PartialAsync("~/Views/Shared/_AlertModal.cshtml", emptyVarietyAlert)
</form>

@section Scripts {
   @*  <script type="text/javascript">
        var orgId = @Model.AppViewModel.Organization.Id;
        var growerId = @Model.AppViewModel.Organization.Id;
        var renderFormRemainder = "@Model.AppViewModel.RenderFormRemainder".toLocaleLowerCase();
        var appTypeId = @Model.AppViewModel.AppTypeId;
        // How many field history records are possible for this application
        let maxFieldHistories = @Model.AppViewModel.MaxFieldHistoryRecords;
        let secondPsRendered = false;
        let fhEntryId = -1;

        // Converting our fixed-size array of booleans from the model to a JavaScript array
        // for use with removing/adding field history entries
        let fhIndices = @Model.AppViewModel.FieldHistoryIndices;

        // Counts the occurrences of used spaces in fhIndices\
        // Used spaces are indicated by 1s. Free spaces are marked with 0s.
        let fhEntryCount = countOccurrences(1, fhIndices);
    </script> *@
    <script src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/jquery-ui.js"></script>
    <script src="~/js/applications/createApplications.js" asp-append-version="true"></script>
   
} 