@model CCIA.Models.BulkSalesCreateViewModel.BulkSalesCreateViewModel


@{
    ViewData["Title"] = "Create New Bulk Sales Certificate";
}

<h1>Create</h1>

<h4>Bulk Sales Certificate</h4>
<hr>
<div class="row">
    <div class="col-sm-10">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group required has-feedback row">
                <label asp-for="BulkSalesCertificate.Date" class="col-sm-3 col-form-label"></label>
                <div class="input-group col-sm-3">
                    <input asp-for="BulkSalesCertificate.Date" class="form-control datepicker" placeholder="MM/DD/YYYY" type="text" />  
                    <div class="input-group-append" onclick="$('.datepicker').focus();">             
                        <i class="fa fa-calendar input-group-text"></i>
                    </div>
                </div>               
                <span asp-validation-for="BulkSalesCertificate.Date" class="text-danger"></span>
            </div>
            <div class="form-group required row">
                <label class="col-sm-3 col-form-label" asp-for="textId"></label>
                <input class="form-control col-sm-2" type="text" asp-for="textId" />&nbsp;
                <select class="form-control col-sm-1" asp-for="selectType">
                    <option value="SID">SID</option>
                    <option value="Blend">Blend</option>
                </select>&nbsp;
                <button type="button" id="retrieveButton" class="btn btn-info">Retrieve Info</button>                 
            </div>
            <div>
                <span id="results"></span>
            </div>
            <div class="form-group required row">
                <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.ClassId"></label>
                <select class="form-control col-sm-4" asp-for="BulkSalesCertificate.ClassId"></select>
            </div>
            <div class="form-group required row">
                <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.Pounds"></label>
                <input asp-for="BulkSalesCertificate.Pounds" class="form-control col-sm-3">
            </div>
            <div><hr/></div>
            <section class="rounded-section off-white">
                <h4>Bulk Sales Certificate To:</h4>
                <section class="rounded-section light-grey">
                    <div>
                        <div class="form-group row">
                            <label for="myCustomers" class="col-sm-3 col-form-label">Select <i>My Customers</i></label>
                            <select id="MyCustomerSelect" class="form-control col-sm-3" asp-items="@(new SelectList(Model.Customers, "Id","Name"))"></select>
                        </div>
                    </div>
                    <h4>Or...</h4>
                </section>
                <hr>
                <section class="rounded-section light-grey">
                    <div>
                        <div class="form-group row">
                            <label for="orgId" class="col-sm-4 col-form-label">Retrieve from Org (enter Name or Id)</label>
                            <input type="text" id="OrgId" class="form-control col-sm-3"></input>&nbsp;
                            <button type="button" id="retrieveFromOrgIdButton" class="btn btn-info">Retrieve Org Info</button>
                        </div>
                    </div>
                    <div id="orgDiv" class="collapse">pick one</div>
                    <h4>Or...just fill in the appropriate fields below</h4>
                </section>
                <hr>
                <section class="rounded-section light-grey">
                    <h5></h5>
                    <div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.PurchaserName"></label>
                            <input asp-for="BulkSalesCertificate.PurchaserName" class="form-control col-sm-4"></input>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.PurchaserAddressLine1"></label>
                            <input asp-for="BulkSalesCertificate.PurchaserAddressLine1" class="form-control col-sm-4"></input>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.PurchaserAddressLine2"></label>
                            <input asp-for="BulkSalesCertificate.PurchaserAddressLine2" class="form-control col-sm-4"></input>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.PurchaserCity"></label>
                            <input asp-for="BulkSalesCertificate.PurchaserCity" class="form-control col-sm-4"></input>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.PurchaserStateId"></label>
                            <select asp-for="BulkSalesCertificate.PurchaserStateId" class="form-control col-sm-4" asp-items="@(new SelectList(Model.StateProvinces, "StateProvinceId","Name"))"></select>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.PurchaserCountryId"></label>
                            <select asp-for="BulkSalesCertificate.PurchaserCountryId" class="form-control col-sm-4" asp-items="@(new SelectList(Model.Countries, "Id","Name"))"></select>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.PurchaserZip"></label>
                            <input asp-for="BulkSalesCertificate.PurchaserZip" class="form-control col-sm-4"></input>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.PurchaserPhone"></label>
                            <input asp-for="BulkSalesCertificate.PurchaserPhone" class="form-control col-sm-4"></input>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label" asp-for="BulkSalesCertificate.PurchaserEmail"></label>
                            <input asp-for="BulkSalesCertificate.PurchaserEmail" class="form-control col-sm-4"></input>
                        </div>
                    </div>
                </section>
            </section>  
            <div class="form-group">
                <input id="SubmitButton" type="submit" value="Create" class="btn btn-primary" disabled />
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/jquery-ui.js"></script>
    
    <script type="text/javascript">
        var arr = [];
        $('.datepicker').datepicker({
            
            format: 'LT',
            autoclose: "true",
        })

        $(document).ready(function () {
            $('#retrieveButton').click(function () {
                var id = $('#textId').val();
                var idType = $('#selectType').val();

                $.ajax({
                    method: 'Get',
                    url: '/client/BulkSalesCertificates/GetAvailableClasses',
                     data: {
                        id: id,
                        lookupType: idType
                    }
                })
                .done(function(data) {
                    $('#BulkSalesCertificate_ClassId').empty();
                    //alert(data.count());
                    $.each(data,function(i,data)
                    {
                        var div_data="<option value="+data.value+">"+data.text+"</option>";
                        $(div_data).appendTo('#BulkSalesCertificate_ClassId');
                    });

                })
                .fail(function(xhr) {
                    $("#SubmitButton").prop("disabled", true);
                    alert("Could not get list of available classes");
                    console.log('error', xhr);
                });                

                $.ajax({
                    method: 'GET',
                    url: '/client/BulkSalesCertificates/GetSidOrBlend',
                    data: {
                        id: id,
                        lookupType: idType
                    }
                })
                .done(function(data){
                    $('#results').html("");
                    var s = '<br>Id: ' + data.id;                        
                        s += '<br>App Type: ' + data.saleType;
                        s += '<br>Program Type: ' + data.program;
                        s += '<br>Applicant: ' + data.applicant;
                        s += '<br>Conditioner: ' + data.conditioner;
                        s += '<br>Crop: ' + data.crop;
                        s += '<br>Variety: ' + data.variety;
                        s += '<br>Cert Number: ' + data.cert;
                        s += '<br>Lot Number: ' + data.lot;
                        s += '<hr/>';
                        $('#results').html(s);
                    $("#SubmitButton").removeAttr("disabled");
                })
                .fail(function(xhr) {
                    $("#SubmitButton").prop("disabled", true);
                    alert("Could not find info on that ID/Type");
                    console.log('error', xhr);
                });
            });

            $('#MyCustomerSelect').change(function () {
                var id = $('#MyCustomerSelect').val();
                $.ajax({
                    method: 'Get',
                    url: '/client/BulkSalesCertificates/GetMyCustomerInfo',
                    data: {
                        id: id,
                    }
                })
                .done(function(data){
                    //alert(data.name);
                    populateForm(data);
                })
                .fail(function(xhr) {
                    alert("Could not retrieve 'My Customer' information");
                    console.log('error', xhr);
                });                
            });

            $('#retrieveFromOrgIdButton').click(function () {
                var id = $('#OrgId').val();
                $.ajax({
                    method: 'Get',
                    url: '/client/BulkSalesCertificates/GetMyCustomerFromOrgIdOrName',
                    data: { search: id, }
                })
                .done(function(data){                    
                    if(data.length == 1)
                    {
                        var singleRow = data[0];
                        populateForm(singleRow);
                            $('#orgDiv').hide();
                    } else 
                    {
                        alert("Multiple records found. Please select the correct one below.");
                        populateSelect(data);
                    }
                })
                .fail(function(xhr) {
                    alert("Could not retrieve 'My Customer' information");
                    console.log('error', xhr);
                }); 
            });
        });

        function populateSelect(dataarray)
        {
            arr = dataarray;
            let i = 0;
            var div = $('#orgDiv');
            var rows = "<hr>";
            while (i < dataarray.length) {
                rows += buildRow(dataarray[i], i);
                i++;
            }
            div.html(rows);
            div.show();
        }

        function buildRow(data, rowNumber)
        {
            var row = "<div><input type='button' value='Select' onclick='useRow(" + rowNumber + ")' class='btn btn-success'> " + data.name;
            if(data.address1 != "")
            {
                row += ", " + data.address1
            }
            if (data.city != "") {
                row += ", " + data.city
            }
            if (data.phone != "") {
                row += ", " + data.phone
            }
            row += "</div><hr>";
            return row;
        }

        function useRow(i)
        {
            populateForm(arr[i]);
            $('#orgDiv').hide();
        }
        function populateForm(data) {
            $('#BulkSalesCertificate_PurchaserName').val(data.name);
            $('#BulkSalesCertificate_PurchaserAddressLine1').val(data.address1);
            $('#BulkSalesCertificate_PurchaserAddressLine2').val(data.address2);
            $('#BulkSalesCertificate_PurchaserCity').val(data.city);
            $('#BulkSalesCertificate_PurchaserStateId').val(data.stateId);
            $('#BulkSalesCertificate_PurchaserCountryId').val(data.countryId);
            $('#BulkSalesCertificate_PurchaserZip').val(data.zip);
            $('#BulkSalesCertificate_PurchaserPhone').val(data.phone);
            $('#BulkSalesCertificate_PurchaserEmail').val(data.email);

        }
    </script>
}